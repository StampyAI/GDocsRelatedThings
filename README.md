# How to use this

## Install all dependancies:

    npm install

## Setup [Clasp](https://github.com/google/clasp)

1. Grant Clasp access to your project: `npx clasp login`
2. Enable the [Google Apps Script API](https://script.google.com/home/usersettings)
3. Create a new Script app :`npx clasp create --type docs --title Stampy-parser`

## Deploy your code to Scripts:

For a one off deployment, use `npx clasp push`.
If you want to develop locally and have your changes automatically synced, use `npx clasp push --watch`.

## Setup API keys:

1. Put your Coda API token in utils.js on line 2 - you can generate one at https://coda.io/account -> API Settings. This
will need to be a Read/Write token for the Answers table (or the whole doc) for everything to work, but for testing purposes
a Read token will be fine - it'll just fail when writing to Coda.
2. If you want to ping Discord on failures (you probably don't...), provide the appropriate tokens in the utils.js::sendToDiscord() function

## Setup Docs API access:

1. Go to https://script.google.com and select your project
2. Add the "Docs API" service from the Services tab on the left sidebar

## Execution

1. Run `parseAllAnswerDocs` in `main.gs`
2. That's it

# High-level execution overview

1. Load all questions from Coda
2. For each question
   1. Load the relevant Google Doc
   2. Split the Doc into content and related answer links
   3. Extract the google Doc ID for related answers, if there are any
   4. For each related Doc ID:
      1. Look up the name of the answer in Coda that corresponds to the Doc ID
   5. Check if the rest of the Doc content is just a LW / EAF link
      1. If so, get the markdown representation of the relevant link and return it
      2. If not:
         1. Split the Doc content into paragraphs
         2. For each paragraph
            1. Split the paragraph into elements
            2. For each element:
               1. Run a relevant element parser on the element
               2. If the element contains any suggestions:
                  1. Store the suggestion ID so we can count the total number of suggestions in the doc
                  2. Store the length of the markdown generated by the suggestion
            3. Join all the markdown strings for the elements into one paragraph
         3. Join all the markdown strings for the paragraphs, injecting new lines between them
   6. Search the document for footnotes
   7. For each footnote:
      1. Add the relevant markdown to the bottom of the doc, using the paragraph parser mentioned in 2.v.b.b
   8. Return all of:
      - The markdown generated in 2.v.5
      - The related answer names generated in 2.iv.a
      - The count and total size of all suggestions generated in 2.v.b.b.b.b
3. Shove all this new data into the row in Coda
4. TODO: Send an update on the suggestion count / size to Discord
